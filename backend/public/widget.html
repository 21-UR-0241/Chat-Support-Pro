<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Widget - Debug Version</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #4a5568;
      --primary-dark: #2d3748;
      --primary-light: #718096;
      --success-color: #10b981;
      --bg-color: #f7fafc;
      --text-color: #1a202c;
      --text-secondary: #718096;
      --border-color: #e2e8f0;
      --white: #ffffff;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg-color);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #chat-header {
      background: var(--white);
      color: var(--text-color);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    #chat-header .avatar {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 600;
    }

    #chat-header .info {
      flex: 1;
    }

    #chat-header .info h3 {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    #chat-header .info p {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success-color);
      margin-right: 6px;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* DEBUG PANEL */
    #debug-panel {
      position: fixed;
      bottom: 70px;
      right: 20px;
      background: white;
      border: 2px solid #ef4444;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      max-width: 300px;
    }

    #debug-panel h4 {
      margin: 0 0 8px 0;
      color: #ef4444;
      font-size: 14px;
    }

    #debug-panel button {
      background: #ef4444;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      margin: 4px;
    }

    #debug-panel button:hover {
      background: #dc2626;
    }

    #debug-info {
      font-size: 11px;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #fee2e2;
      color: #666;
      word-break: break-all;
    }

    #chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: var(--bg-color);
    }

    #chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    #chat-messages::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 3px;
    }

    .loading-history {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: var(--text-secondary);
      font-size: 14px;
      gap: 8px;
    }
    
    .loading-history .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border-color);
      border-top-color: var(--primary-color);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    #email-collection {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
    }

    #email-collection.visible {
      display: flex;
    }

    #email-collection .icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 20px;
      background: var(--bg-color);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--border-color);
    }

    #email-collection .icon svg {
      width: 32px;
      height: 32px;
      color: var(--primary-color);
    }

    #email-collection h2 {
      font-size: 22px;
      color: var(--text-color);
      margin-bottom: 8px;
    }

    #email-collection p {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 24px;
    }

    .email-form {
      width: 100%;
      max-width: 400px;
    }

    .form-group {
      margin-bottom: 16px;
      text-align: left;
    }

    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 6px;
    }

    .form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 15px;
      outline: none;
    }

    .form-group input.error {
      border-color: #ef4444;
    }

    .form-group .error-text {
      color: #dc2626;
      font-size: 12px;
      margin-top: 4px;
      display: none;
    }

    .form-group .error-text.visible {
      display: block;
    }

    .submit-button {
      width: 100%;
      padding: 14px 24px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }

    .privacy-note {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 16px;
    }

    #welcome-message {
      display: none;
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    #welcome-message.visible {
      display: block;
    }

    #welcome-message .welcome-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 16px;
      background: var(--bg-color);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--border-color);
    }

    #welcome-message .welcome-icon svg {
      width: 24px;
      height: 24px;
      color: var(--primary-color);
    }

    #welcome-message h2 {
      font-size: 18px;
      margin-bottom: 8px;
    }

    #welcome-message p {
      font-size: 14px;
    }

    .message {
      display: flex;
      gap: 8px;
      max-width: 85%;
      animation: slideIn 0.3s ease;
    }

    .message.history {
      animation: none;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.customer {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message .avatar {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: var(--primary-light);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .message.customer .avatar {
      background: var(--primary-color);
    }

    .message .bubble {
      background: white;
      padding: 10px 14px;
      border-radius: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.08);
      border: 1px solid var(--border-color);
    }

    .message.customer .bubble {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    .message.pending .bubble {
      opacity: 0.7;
    }

    .message .sender-name {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .message .text {
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .message .time {
      font-size: 11px;
      color: var(--text-secondary);
      margin-top: 4px;
      opacity: 0.7;
    }

    .message.customer .time {
      color: rgba(255,255,255,0.8);
    }

    .message.system {
      align-self: center;
      max-width: 100%;
    }

    .message.system .bubble {
      background: #fef2f2;
      border-color: #fecaca;
      color: #dc2626;
      font-size: 13px;
      padding: 8px 12px;
    }

    #chat-input-container {
      padding: 16px 20px;
      background: white;
      border-top: 1px solid var(--border-color);
      display: none;
      gap: 10px;
      flex-shrink: 0;
    }

    #chat-input-container.visible {
      display: flex;
    }

    #chat-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      resize: none;
      max-height: 120px;
    }

    #send-button {
      width: 44px;
      height: 44px;
      border-radius: 8px;
      background: var(--primary-color);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #send-button:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div id="chat-header">
    <div class="avatar" id="header-avatar">CS</div>
    <div class="info">
      <h3 id="brand-name">Chat Support</h3>
      <p id="status">
        <span class="status-indicator" id="status-indicator"></span>
        <span id="status-text">Loading...</span>
      </p>
    </div>
  </div>

  <!-- DEBUG PANEL -->
  <div id="debug-panel">
    <h4>üîç Debug Panel</h4>
    <button onclick="testLoadHistory()">Load History</button>
    <button onclick="checkLocalStorage()">Check Storage</button>
    <button onclick="clearAllData()">Clear All</button>
    <div id="debug-info"></div>
  </div>

  <div id="chat-messages">
    <div id="email-collection">
      <div class="icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
          <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
      </div>
      <h2>Welcome! Let's get started</h2>
      <p>Please enter your email address to continue.</p>
      
      <form class="email-form" id="email-form">
        <div class="form-group">
          <label for="customer-email">Email Address *</label>
          <input 
            type="email" 
            id="customer-email" 
            name="email"
            placeholder="your@email.com"
            required
          >
          <div class="error-text" id="email-error">Please enter a valid email address</div>
        </div>
        
        <div class="form-group">
          <label for="customer-name">Name (Optional)</label>
          <input 
            type="text" 
            id="customer-name" 
            name="name"
            placeholder="Your name"
          >
        </div>
        
        <button type="submit" class="submit-button">Start Chat</button>
        
        <p class="privacy-note">Your information is secure.</p>
      </form>
    </div>

    <div id="welcome-message">
      <div class="welcome-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
      </div>
      <h2>Welcome!</h2>
      <p>How can we help you today?</p>
    </div>
  </div>

  <div id="chat-input-container">
    <textarea 
      id="chat-input" 
      placeholder="Type your message..."
      rows="1"
    ></textarea>
    <button id="send-button" disabled>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="22" y1="2" x2="11" y2="13"></line>
        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
      </svg>
    </button>
  </div>

  <script>
    console.log('üöÄ [Widget] Starting...');

    const urlParams = new URLSearchParams(window.location.search);
    const STORE_ID = urlParams.get('store');
    const API_URL = window.location.origin;

    let conversationId = null;
    let customerEmail = null;
    let customerName = null;
    let displayedMessageIds = new Set();
    let historyLoaded = false;

    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const emailCollection = document.getElementById('email-collection');
    const welcomeMessage = document.getElementById('welcome-message');
    const chatInputContainer = document.getElementById('chat-input-container');
    const emailForm = document.getElementById('email-form');
    const debugInfo = document.getElementById('debug-info');

    function updateDebugInfo(info) {
      debugInfo.innerHTML = info;
      console.log('üìä [Debug]', info);
    }

    function getInitials(name) {
      if (!name) return 'CS';
      const parts = name.trim().split(' ');
      if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
      return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function formatMessageTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ‚úÖ DEBUG FUNCTIONS
    function checkLocalStorage() {
      const email = localStorage.getItem(`chat_email_${STORE_ID}`);
      const name = localStorage.getItem(`chat_name_${STORE_ID}`);
      const conv = localStorage.getItem(`chat_conv_${STORE_ID}`);
      
      const info = `
        <div><strong>Store:</strong> ${STORE_ID}</div>
        <div><strong>Email:</strong> ${email || 'None'}</div>
        <div><strong>Name:</strong> ${name || 'None'}</div>
        <div><strong>Conv ID:</strong> ${conv || 'None'}</div>
      `;
      
      updateDebugInfo(info);
      
      console.log('üíæ [Storage] Email:', email);
      console.log('üíæ [Storage] Name:', name);
      console.log('üíæ [Storage] ConversationId:', conv);
    }

    function clearAllData() {
      localStorage.removeItem(`chat_email_${STORE_ID}`);
      localStorage.removeItem(`chat_name_${STORE_ID}`);
      localStorage.removeItem(`chat_conv_${STORE_ID}`);
      conversationId = null;
      customerEmail = null;
      customerName = null;
      historyLoaded = false;
      displayedMessageIds.clear();
      
      console.log('üóëÔ∏è [Storage] All data cleared');
      updateDebugInfo('All data cleared!');
      
      location.reload();
    }

    // ‚úÖ MAIN: Load conversation history
    async function loadConversationHistory() {
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log('üìú [HISTORY] STARTING LOAD');
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      
      if (!conversationId) {
        console.log('‚ùå [History] No conversationId');
        updateDebugInfo('No conversation ID');
        return;
      }

      if (historyLoaded) {
        console.log('‚ÑπÔ∏è [History] Already loaded');
        return;
      }

      try {
        console.log('üìú [History] ConversationId:', conversationId);
        console.log('üìú [History] Store:', STORE_ID);
        
        showLoadingHistory();
        
        // Try multiple endpoint formats
        const endpoints = [
          `${API_URL}/api/conversations/${conversationId}/messages?store=${STORE_ID}`,
          `${API_URL}/api/widget/messages?conversationId=${conversationId}&store=${STORE_ID}`,
          `${API_URL}/api/messages?conversationId=${conversationId}&store=${STORE_ID}`,
        ];

        let response = null;
        let usedEndpoint = null;

        for (const endpoint of endpoints) {
          console.log('üîó [History] Trying:', endpoint);
          
          try {
            const res = await fetch(endpoint);
            console.log('üì° [History] Response status:', res.status);
            
            if (res.ok) {
              response = res;
              usedEndpoint = endpoint;
              console.log('‚úÖ [History] Success with:', endpoint);
              break;
            } else {
              console.log('‚ö†Ô∏è [History] Failed:', endpoint, 'Status:', res.status);
            }
          } catch (err) {
            console.log('‚ùå [History] Error with:', endpoint, err.message);
          }
        }

        if (!response || !response.ok) {
          console.log('‚ùå [History] All endpoints failed');
          updateDebugInfo('All API endpoints failed');
          hideLoadingHistory();
          welcomeMessage.classList.add('visible');
          return;
        }

        const data = await response.json();
        console.log('üì¶ [History] Raw data:', data);
        console.log('üì¶ [History] Data type:', typeof data);
        console.log('üì¶ [History] Is array:', Array.isArray(data));
        
        // Parse messages from different formats
        let messages = [];
        
        if (Array.isArray(data)) {
          messages = data;
          console.log('‚úÖ [History] Data is array');
        } else if (data.messages && Array.isArray(data.messages)) {
          messages = data.messages;
          console.log('‚úÖ [History] Data has messages array');
        } else if (data.data && Array.isArray(data.data)) {
          messages = data.data;
          console.log('‚úÖ [History] Data has data array');
        } else {
          console.log('‚ùå [History] Unknown data format');
        }
        
        console.log('üìä [History] Total messages:', messages.length);
        updateDebugInfo(`Found ${messages.length} messages from ${usedEndpoint}`);

        hideLoadingHistory();
        
        if (messages.length > 0) {
          welcomeMessage.style.display = 'none';
          
          messages.forEach((msg, index) => {
            console.log(`‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ`);
            console.log(`üìù [History] Message #${index + 1}:`);
            console.log('  ID:', msg.id);
            console.log('  Type:', msg.senderType || msg.sender_type || msg.type);
            console.log('  Sender:', msg.senderName || msg.sender_name);
            console.log('  Content:', (msg.content || msg.message || msg.text || '').substring(0, 50));
            console.log('  Time:', msg.createdAt || msg.created_at || msg.timestamp);
            
            displayHistoryMessage(msg);
          });
          
          console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
          
          historyLoaded = true;
          
          setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
            console.log('üìú [History] Scrolled to bottom');
          }, 100);
        } else {
          console.log('‚ÑπÔ∏è [History] No messages');
          welcomeMessage.classList.add('visible');
        }

        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('‚úÖ [HISTORY] COMPLETED');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

      } catch (error) {
        console.error('‚ùå [History] Error:', error);
        console.error('‚ùå [History] Stack:', error.stack);
        updateDebugInfo(`Error: ${error.message}`);
        hideLoadingHistory();
        welcomeMessage.classList.add('visible');
      }
    }

    function displayHistoryMessage(msg) {
      const message = {
        id: msg.id,
        senderType: msg.senderType || msg.sender_type || msg.type || 'agent',
        senderName: msg.senderName || msg.sender_name || msg.sender || 'Support',
        content: msg.content || msg.message || msg.text || '',
        timestamp: msg.createdAt || msg.created_at || msg.timestamp || new Date().toISOString()
      };

      if (displayedMessageIds.has(message.id)) {
        console.log('  ‚è≠Ô∏è Skip duplicate:', message.id);
        return;
      }

      console.log('  ‚úèÔ∏è Display message:', message.id);

      displayedMessageIds.add(message.id);

      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${message.senderType} history`;
      messageDiv.dataset.messageId = message.id;
      
      const time = formatMessageTime(message.timestamp);
      const avatarText = message.senderType === 'customer' 
        ? getInitials(customerName || message.senderName) 
        : getInitials(message.senderName);
      
      const senderName = message.senderType !== 'system' 
        ? `<div class="sender-name">${escapeHtml(message.senderName)}</div>` 
        : '';
      
      messageDiv.innerHTML = `
        <div class="avatar">${avatarText}</div>
        <div class="bubble">
          ${senderName}
          <div class="text">${escapeHtml(message.content)}</div>
          <div class="time">${time}</div>
        </div>
      `;
      
      chatMessages.appendChild(messageDiv);
    }

    function showLoadingHistory() {
      hideLoadingHistory();
      
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'loading-history';
      loadingDiv.id = 'loading-history-indicator';
      loadingDiv.innerHTML = `
        <div class="spinner"></div>
        <span>Loading conversation...</span>
      `;
      
      chatMessages.appendChild(loadingDiv);
    }

    function hideLoadingHistory() {
      const loading = document.getElementById('loading-history-indicator');
      if (loading) loading.remove();
    }

    // ‚úÖ MANUAL TEST FUNCTION
    window.testLoadHistory = async function() {
      console.log('üîß [Test] Manual history load triggered');
      historyLoaded = false;
      displayedMessageIds.clear();
      
      // Clear existing messages
      const messages = chatMessages.querySelectorAll('.message');
      messages.forEach(m => m.remove());
      
      checkLocalStorage();
      await loadConversationHistory();
    };

    window.checkLocalStorage = checkLocalStorage;
    window.clearAllData = clearAllData;

    emailForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('customer-email').value.trim();
      const name = document.getElementById('customer-name').value.trim();
      
      if (!isValidEmail(email)) {
        return;
      }
      
      customerEmail = email;
      customerName = name || 'Guest';
      
      localStorage.setItem(`chat_email_${STORE_ID}`, customerEmail);
      localStorage.setItem(`chat_name_${STORE_ID}`, customerName);
      
      console.log('‚úÖ [Email] Saved:', customerEmail);
      
      await showChatInterface();
    });

    async function showChatInterface() {
      console.log('üé® [UI] Show interface');
      
      emailCollection.classList.remove('visible');
      chatInputContainer.classList.add('visible');
      
      if (conversationId && !historyLoaded) {
        console.log('üìú [UI] Has conversation, loading history...');
        await loadConversationHistory();
      } else {
        console.log('üìú [UI] No conversation or already loaded');
        welcomeMessage.classList.add('visible');
      }
      
      chatInput.focus();
    }

    function autoDetectCustomer() {
      console.log('üîç [Detect] Starting...');
      
      try {
        if (window.parent && window.parent.chatCustomerData) {
          const data = window.parent.chatCustomerData;
          console.log('‚úÖ [Detect] Found in parent:', data.email);
          return {
            email: data.email,
            name: data.name || data.firstName,
            autoDetected: true
          };
        }
      } catch (e) {
        console.log('‚ÑπÔ∏è [Detect] No parent data');
      }
      
      const urlEmail = urlParams.get('email');
      if (urlEmail && isValidEmail(urlEmail)) {
        console.log('‚úÖ [Detect] Found in URL:', urlEmail);
        return {
          email: urlEmail,
          name: urlParams.get('name') || null,
          autoDetected: true
        };
      }
      
      try {
        const storedEmail = localStorage.getItem(`chat_email_${STORE_ID}`);
        const storedName = localStorage.getItem(`chat_name_${STORE_ID}`);
        
        if (storedEmail && isValidEmail(storedEmail)) {
          console.log('‚úÖ [Detect] Found in storage:', storedEmail);
          return {
            email: storedEmail,
            name: storedName || null,
            autoDetected: true
          };
        }
      } catch (e) {}

      console.log('‚ÑπÔ∏è [Detect] Nothing found');
      return null;
    }

    async function init() {
      try {
        console.log('[Widget] Init');
        
        const detected = autoDetectCustomer();
        
        if (detected) {
          customerEmail = detected.email;
          customerName = detected.name || 'Guest';
          
          localStorage.setItem(`chat_email_${STORE_ID}`, customerEmail);
          if (customerName) localStorage.setItem(`chat_name_${STORE_ID}`, customerName);
          
          conversationId = localStorage.getItem(`chat_conv_${STORE_ID}`);
          
          console.log('[Widget] Detected email:', customerEmail);
          console.log('[Widget] Conversation ID:', conversationId);
          
          updateDebugInfo(`Email: ${customerEmail}<br>Conv: ${conversationId || 'None'}`);
          
          await showChatInterface();
        } else {
          console.log('[Widget] No detection, show form');
          emailCollection.classList.add('visible');
        }
        
        console.log('[Widget] Init complete');
        checkLocalStorage();
      } catch (error) {
        console.error('‚ùå [Widget] Init failed:', error);
      }
    }

    chatInput.addEventListener('input', () => {
      sendButton.disabled = !chatInput.value.trim();
    });

    init();
  </script>
</body>
</html>















